CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `d_store`.`customer_count_by_state_and_membership` AS select `t`.`state` AS `state`,`t`.`membership` AS `membership`,`t`.`count` AS `count`,dense_rank() OVER (PARTITION BY `t`.`state` ORDER BY `t`.`count` desc )  AS `_rank` from (select `d_store`.`customers`.`state` AS `state`,(case when (`d_store`.`customers`.`points` >= 3000) then 'Gold' when (`d_store`.`customers`.`points` >= 2000) then 'Silver' when (`d_store`.`customers`.`points` >= 1000) then 'Bronze' else 'Basic' end) AS `membership`,count(0) AS `count` from `d_store`.`customers` group by `d_store`.`customers`.`state`,`membership`) `t`