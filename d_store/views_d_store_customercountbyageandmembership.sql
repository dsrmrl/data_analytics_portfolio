CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `d_store`.`customer_count_by_age_and_membership` AS select `t`.`age_group` AS `age_group`,`t`.`membership` AS `membership`,`t`.`count` AS `count`,dense_rank() OVER (PARTITION BY `t`.`age_group` ORDER BY `t`.`count` desc )  AS `_rank` from (select (case when (timestampdiff(YEAR,`d_store`.`customers`.`birth_date`,curdate()) < 25) then 'Under 25' when (timestampdiff(YEAR,`d_store`.`customers`.`birth_date`,curdate()) between 25 and 44) then '25-44' when (timestampdiff(YEAR,`d_store`.`customers`.`birth_date`,curdate()) between 45 and 64) then '45-64' else '65+' end) AS `age_group`,(case when (`d_store`.`customers`.`points` >= 3000) then 'Gold' when (`d_store`.`customers`.`points` >= 2000) then 'Silver' when (`d_store`.`customers`.`points` >= 1000) then 'Bronze' else 'Basic' end) AS `membership`,count(0) AS `count` from `d_store`.`customers` group by `age_group`,`membership`) `t` order by field(`t`.`age_group`,'Under 25','25-44','45-64','65+')